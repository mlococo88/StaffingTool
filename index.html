<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staffing Tool | Structural Resource Planning</title>
    
    <!-- Environment Shim -->
    <script>window.process = { env: { NODE_ENV: 'development' } };</script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Compatibility Shim -->
    <script>window.react = window.React;</script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide-react@0.263.1/dist/umd/lucide-react.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        slate: { 850: '#151e2e', 900: '#0f172a' },
                        blue: { 950: '#172554' }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f1f5f9; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px); border: 1px solid rgba(226, 232, 240, 0.8); }
        .animate-enter { animation: enter 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes enter { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;
        const icons = window.lucide || window.lucideReact || {};
        const { 
            LayoutDashboard, Users, HardHat, CalendarRange, Search, Bell, Filter, ChevronDown, ChevronLeft, ChevronRight, Plus, 
            MoreHorizontal, AlertCircle, CheckCircle2, Briefcase, TrendingUp, Settings, Menu, X, ArrowRight, Download, Trash2, 
            Edit, Save, ClipboardList, MessageSquare, PlusCircle, MinusCircle, Clock, FileText, AlertTriangle, Calendar, 
            CheckSquare, ListTodo, ExternalLink, User, DollarSign, Zap, Copy, StickyNote, CalendarDays, Archive, RotateCcw,
            Upload, Database
        } = icons;

        // --- Constants & Data ---
        const CERTS = { PE: 'PE', SE: 'SE', NBIS: 'NBIS TL' };
        const SKILLS = {
            SEISMIC: { label: 'Seismic Retrofit', color: 'bg-rose-100 text-rose-700' },
            STEEL: { label: 'Complex Steel', color: 'bg-slate-100 text-slate-700' },
            CONCRETE: { label: 'Prestressed Concrete', color: 'bg-stone-100 text-stone-700' },
            INSPECTION: { label: 'NBIS Inspection', color: 'bg-amber-100 text-amber-700' },
            PM: { label: 'Project Mgmt', color: 'bg-blue-100 text-blue-700' }
        };

        const INITIAL_ENGINEERS = [
            { id: 1, name: 'Elena Rossi', role: 'Principal Engineer', certs: [CERTS.PE, CERTS.SE], capacity: 40, avatar: 'ER', rate: 210, status: 'Active', renewal: '2025-06-15' },
            { id: 2, name: 'James Thorne', role: 'Senior Structural', certs: [CERTS.PE, CERTS.NBIS], capacity: 100, avatar: 'JT', rate: 165, status: 'Active', renewal: '2023-12-01' },
            { id: 3, name: 'Sarah Chen', role: 'Project Engineer', certs: [CERTS.PE], capacity: 100, avatar: 'SC', rate: 135, status: 'Active', renewal: '2024-04-20' },
            { id: 4, name: 'David Kim', role: 'EIT / Designer', certs: [], capacity: 100, avatar: 'DK', rate: 105, status: 'Active', renewal: '' },
            { id: 5, name: 'Marcus Cole', role: 'CAD Manager', certs: [], capacity: 100, avatar: 'MC', rate: 115, status: 'PTO', renewal: '' },
        ];

        // --- Date Helper Functions ---
        const getMonday = (d) => {
            const date = new Date(d);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(date.setDate(diff));
            monday.setHours(0, 0, 0, 0);
            return monday;
        };

        const formatDateKey = (date) => {
            return date.toISOString().split('T')[0];
        };

        // --- Initial Allocations Generator (Dynamic Dates) ---
        const getInitialAllocations = () => {
            const today = new Date();
            const monday = getMonday(today);
            const keys = [0, 1, 2, 3].map(i => {
                const d = new Date(monday);
                d.setDate(d.getDate() + (i * 7));
                return formatDateKey(d);
            });

            return [
                { id: 1, engId: 1, projectName: 'I-95 Viaduct Replacement', schedule: { [keys[0]]: 0.5, [keys[1]]: 0.5, [keys[2]]: 0.75, [keys[3]]: 0.75 } },
                { id: 2, engId: 1, projectName: 'Mystic River Swing Bridge', schedule: { [keys[0]]: 0.25, [keys[1]]: 0.25, [keys[2]]: 0.25, [keys[3]]: 0.25 } },
                { id: 3, engId: 1, projectName: 'Suspension Cable Rehab', schedule: { [keys[0]]: 1.0, [keys[1]]: 1.0, [keys[2]]: 0.5, [keys[3]]: 0.5 } },
                { id: 4, engId: 2, projectName: 'Mystic River Swing Bridge', schedule: { [keys[0]]: 2.5, [keys[1]]: 3.0, [keys[2]]: 1.0, [keys[3]]: 1.0 } },
                { id: 5, engId: 2, projectName: 'Suspension Cable Rehab', schedule: { [keys[0]]: 2.0, [keys[1]]: 1.5, [keys[2]]: 4.0, [keys[3]]: 4.0 } },
                { id: 6, engId: 3, projectName: 'I-95 Viaduct Replacement', schedule: { [keys[0]]: 4.0, [keys[1]]: 4.25, [keys[2]]: 4.5, [keys[3]]: 4.0 } },
                { id: 7, engId: 3, projectName: 'County Culvert Bundle', schedule: { [keys[0]]: 0.5, [keys[1]]: 0.75, [keys[2]]: 0.5, [keys[3]]: 0.5 } },
                { id: 8, engId: 4, projectName: 'I-95 Viaduct Replacement', schedule: { [keys[0]]: 5.0, [keys[1]]: 5.0, [keys[2]]: 5.0, [keys[3]]: 2.5 } },
                { id: 9, engId: 5, projectName: 'I-95 Viaduct Replacement', schedule: { [keys[0]]: 2.5, [keys[1]]: 2.5, [keys[2]]: 3.0, [keys[3]]: 4.0 } },
                { id: 10, engId: 5, projectName: 'Mystic River Swing Bridge', schedule: { [keys[0]]: 1.0, [keys[1]]: 1.0, [keys[2]]: 0.5, [keys[3]]: 0.0 } },
            ];
        };

        const INITIAL_ALLOCATIONS = getInitialAllocations();
        
        const INITIAL_REVIEWS = [
            { id: 1, engId: 2, date: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], workload: 'Managing the Mystic River inspection well.', goals: 'Obtain SE license.', general: 'Requested new safety boots.', customFields: [] }
        ];
        const INITIAL_TASKS = [
            { id: 1, title: 'Review Shop Drawings - Pier 4', assignee: 1, status: 'TODO', priority: 'HIGH', due: '2023-11-01', project: 'I-95 Viaduct', archived: false },
            { id: 2, title: 'Update CAD Standards for Rebar', assignee: 5, status: 'IN_PROGRESS', priority: 'MEDIUM', due: '2023-11-15', project: 'Internal', archived: false },
            { id: 3, title: 'Submit Proposal for County Job', assignee: 0, status: 'TODO', priority: 'HIGH', due: '2023-10-30', project: 'BD', archived: false },
            { id: 4, title: 'NBIS Report QA/QC', assignee: 2, status: 'DONE', priority: 'HIGH', due: '2023-10-20', project: 'Mystic River', archived: false },
        ];

        // --- Global Helpers ---
        const loadState = (key, fallback) => { try { const saved = localStorage.getItem(key); return saved ? JSON.parse(saved) : fallback; } catch (e) { return fallback; } };
        
        // Calculations with Date Keys
        const getUtil = (allocations, engId, dateKey) => {
            return allocations
                .filter(a => a.engId === engId)
                .reduce((sum, a) => sum + (a.schedule?.[dateKey] || 0), 0);
        };
        
        // Calculate total util over provided date keys
        const getTotalUtil = (allocations, engId, dateKeys) => {
            const totalDays = dateKeys.reduce((acc, dateKey) => acc + getUtil(allocations, engId, dateKey), 0);
            return Math.round((totalDays / dateKeys.length / 5) * 100); // % based on 5 day week
        };
        
        // Task Logic
        const isNearDue = (d) => { if(!d)return false; const diff = Math.ceil((new Date(d) - new Date().setHours(0,0,0,0)) / 86400000); return diff >= 0 && diff <= 3; };
        const isOverdue = (d) => { if(!d)return false; return new Date(d) < new Date().setHours(0,0,0,0); };

        // --- Shared Components ---
        const Icon = ({ icon: IconComponent, size = 18, className = "" }) => { if (!IconComponent) return null; return <IconComponent size={size} className={className} />; };
        
        // --- Improved UtilizationCell: Commits on Blur ---
        const UtilizationCell = ({ value, onChange }) => {
            const [localValue, setLocalValue] = useState(value ?? '');
            
            // Sync with parent when prop changes (e.g. initial load or external update)
            useEffect(() => {
                setLocalValue(value ?? '');
            }, [value]);

            const handleBlur = () => {
                const num = parseFloat(localValue);
                onChange(isNaN(num) ? 0 : num);
            };

            const handleChange = (e) => {
                setLocalValue(e.target.value);
            };

            // Calculate colors based on current local input (for instant feedback)
            const numVal = parseFloat(localValue) || 0;
            let bg = "bg-slate-50", txt = "text-slate-400";
            if (numVal > 0 && numVal <= 2.5) { bg = "bg-emerald-50"; txt = "text-emerald-700"; }
            else if (numVal > 2.5 && numVal <= 4.25) { bg = "bg-emerald-100"; txt = "text-emerald-800"; }
            else if (numVal > 4.25 && numVal <= 5.0) { bg = "bg-yellow-100"; txt = "text-yellow-800"; }
            else if (numVal > 5.0) { bg = "bg-red-100"; txt = "text-red-700 font-bold"; }

            return (
                <div className={`relative h-full w-full flex items-center justify-center group transition-colors duration-200 ${bg}`}>
                    <input 
                        type="number" 
                        step="0.25" 
                        value={localValue} 
                        onChange={handleChange}
                        onBlur={handleBlur}
                        className={`w-full h-full text-center bg-transparent outline-none text-xs focus:ring-2 focus:ring-blue-500 focus:bg-white z-10 ${txt}`} 
                    />
                </div>
            );
        };

        // --- SUB-COMPONENTS (Defined Outside to prevent remounting) ---

        // 1. Dashboard
        const DashboardView = ({ engineers, allocations, tasks, reviews, scratchpad, setScratchpad, setView, setSelectedEngFilter, setActionFilter, weekKeys }) => {
            const totalCapacityDays = engineers.length * 5; 
            const currentLoadDays = weekKeys.map(k => engineers.reduce((acc, e) => acc + getUtil(allocations, e.id, k), 0));
            const avgDaysUsed = currentLoadDays.reduce((a,b)=>a+b,0) / 4;
            const avgUtil = totalCapacityDays > 0 ? Math.round((avgDaysUsed / totalCapacityDays) * 100) : 0;
            const urgentTasks = tasks.filter(t => !t.archived && t.status !== 'DONE' && (isNearDue(t.due) || isOverdue(t.due))).length;
            const roles = engineers.reduce((acc, e) => { acc[e.role] = (acc[e.role] || 0) + 1; return acc; }, {});
            const upcomingRenewals = engineers.filter(e => { if(!e.renewal) return false; const diff = Math.ceil((new Date(e.renewal) - new Date()) / 86400000); return diff > 0 && diff < 90; });

            return (
                <div className="space-y-6 animate-enter">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                            <p className="text-[10px] font-bold text-slate-400 uppercase">Team Utilization</p>
                            <div className="flex items-baseline justify-between"><h3 className="text-2xl font-bold text-slate-800">{avgUtil}%</h3><span className="text-xs text-slate-400 font-medium">{Math.round(totalCapacityDays * 8)} hrs/wk avail</span></div>
                        </div>
                        <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                            <p className="text-[10px] font-bold text-slate-400 uppercase">Open Tasks</p>
                            <div className="flex items-baseline space-x-2"><h3 className="text-2xl font-bold text-blue-600">{tasks.filter(t => !t.archived && t.status !== 'DONE').length}</h3>{urgentTasks > 0 && <span className="text-xs font-bold text-rose-500 flex items-center bg-rose-50 px-2 py-0.5 rounded-full border border-rose-100"><Icon icon={AlertTriangle} size={12} className="mr-1" /> {urgentTasks} Urgent</span>}</div>
                        </div>
                        <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm bg-gradient-to-br from-slate-800 to-slate-900 text-white">
                            <p className="text-[10px] font-bold text-slate-300 uppercase">Total Staff</p><h3 className="text-2xl font-bold">{engineers.length}</h3>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-2 bg-white rounded-xl border border-slate-200 shadow-sm p-5 flex flex-col">
                            <h3 className="text-sm font-bold text-slate-700 mb-2 flex items-center"><Icon icon={StickyNote} size={16} className="mr-2 text-amber-500"/> Manager's Scratchpad</h3>
                            <textarea className="w-full h-32 p-3 bg-yellow-50/50 border border-yellow-100 rounded-lg text-sm text-slate-700 focus:outline-none focus:ring-2 focus:ring-yellow-200 resize-none flex-1" placeholder="Notes..." value={scratchpad} onChange={(e) => setScratchpad(e.target.value)}></textarea>
                        </div>
                        <div className="space-y-4">
                            <div className="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                                <h3 className="text-xs font-bold text-slate-400 uppercase mb-3">Team Composition</h3>
                                <div className="space-y-2">{Object.entries(roles).map(([role, count]) => (<div key={role} className="flex justify-between items-center text-xs"><span className="text-slate-600">{role}</span><div className="flex items-center"><div className="w-24 h-1.5 bg-slate-100 rounded-full mr-2 overflow-hidden"><div className="h-full bg-blue-500" style={{width: `${(count/engineers.length)*100}%`}}></div></div><span className="font-bold text-slate-800">{count}</span></div></div>))}</div>
                            </div>
                            {upcomingRenewals.length > 0 && <div className="bg-rose-50 rounded-xl border border-rose-100 p-4"><h3 className="text-xs font-bold text-rose-800 uppercase mb-2 flex items-center"><Icon icon={AlertCircle} size={14} className="mr-1"/> License Alerts</h3>{upcomingRenewals.map(e => <div key={e.id} className="text-xs text-rose-700 mb-1"><span className="font-bold">{e.name}</span>: Renew by {e.renewal}</div>)}</div>}
                        </div>
                    </div>
                    <h2 className="text-lg font-bold text-slate-800 mt-2">Team Utilization</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        {engineers.map(eng => {
                            const utilization = getTotalUtil(allocations, eng.id, weekKeys);
                            const activeTasks = tasks.filter(t => !t.archived && t.assignee === eng.id && t.status !== 'DONE').length;
                            const lastReview = reviews.filter(r => r.engId === eng.id).sort((a,b) => new Date(b.date) - new Date(a.date))[0];
                            let checkInStatus = { label: 'Due', color: 'text-slate-400' };
                            if (lastReview) {
                                const days = Math.floor((new Date() - new Date(lastReview.date)) / 86400000);
                                if (days > 45) checkInStatus = { label: 'Overdue', color: 'text-rose-600 font-bold' };
                                else if (days > 25) checkInStatus = { label: 'Due Soon', color: 'text-amber-600 font-bold' };
                                else checkInStatus = { label: 'Current', color: 'text-emerald-600' };
                            }
                            return (
                                <div key={eng.id} className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden hover:shadow-md transition-shadow">
                                    <div className="p-5">
                                        <div className="flex items-center space-x-3 mb-4">
                                            <div className="w-12 h-12 rounded-xl bg-slate-100 text-slate-600 flex items-center justify-center font-bold text-lg relative">{eng.avatar}{eng.status === 'PTO' && <div className="absolute -top-1 -right-1 w-3 h-3 bg-amber-400 rounded-full border-2 border-white" title="On Leave"></div>}</div>
                                            <div><h4 className="font-bold text-slate-800">{eng.name}</h4><p className="text-xs text-slate-500">{eng.role}</p></div>
                                        </div>
                                        <div className="space-y-4">
                                            <div>
                                                <div className="flex justify-between text-xs mb-1"><span className="text-slate-500">Utilization (Avg %)</span><span className={`font-bold ${utilization > 100 ? 'text-rose-600' : 'text-slate-700'}`}>{utilization}%</span></div>
                                                <div className="w-full bg-slate-100 rounded-full h-1.5"><div className={`h-1.5 rounded-full ${utilization > 100 ? 'bg-rose-500' : utilization > 85 ? 'bg-amber-400' : 'bg-emerald-500'}`} style={{width: `${Math.min(100, utilization)}%`}}></div></div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-2 text-center">
                                                <div className="bg-slate-50 rounded p-2 border border-slate-100"><p className="text-[10px] font-bold text-slate-400 uppercase">Action Items</p><p className={`text-lg font-bold ${activeTasks > 5 ? 'text-amber-600' : 'text-slate-700'}`}>{activeTasks}</p></div>
                                                <div className="bg-slate-50 rounded p-2 border border-slate-100"><p className="text-[10px] font-bold text-slate-400 uppercase">Check-in</p><p className={`text-sm font-bold mt-1 ${checkInStatus.color}`}>{checkInStatus.label}</p></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-slate-50 border-t border-slate-100 p-2 flex divide-x divide-slate-200">
                                        <button onClick={() => setView('planning')} className="flex-1 py-1.5 text-xs font-medium text-slate-600 hover:text-blue-600 transition-colors flex items-center justify-center"><Icon icon={CalendarRange} size={14} className="mr-1" /> Workload</button>
                                        <button onClick={() => { setSelectedEngFilter(eng.id); setView('reviews'); }} className="flex-1 py-1.5 text-xs font-medium text-slate-600 hover:text-emerald-600 transition-colors flex items-center justify-center"><Icon icon={FileText} size={14} className="mr-1" /> Check-ins</button>
                                        <button onClick={() => { setActionFilter(eng.id); setView('tasks'); }} className="flex-1 py-1.5 text-xs font-medium text-slate-600 hover:text-rose-600 transition-colors flex items-center justify-center"><Icon icon={ListTodo} size={14} className="mr-1" /> Actions</button>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // 2. Planning Grid
        const PlanningGrid = ({ searchQuery, setSearchQuery, exportCSV, weekLabels, weekKeys, filteredEngineers, allocations, handleFillWeeks, handleAddProjectRow, handleDeleteAllocation, handleProjectNameChange, handleAllocationWeekChange }) => (
            <div className="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden animate-enter">
                <div className="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50/50">
                    <div className="flex items-center space-x-2 relative"><Icon icon={Search} className="absolute left-3 text-slate-400" size={16} /><input type="text" placeholder="Find engineer..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="pl-9 pr-4 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-64" /></div>
                    <button onClick={exportCSV} className="flex items-center px-3 py-2 bg-white border border-slate-200 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50"><Icon icon={Download} size={16} className="mr-2" /> Export CSV</button>
                </div>
                <div className="overflow-x-auto pb-32">
                    <table className="w-full border-collapse">
                        <thead>
                            <tr>
                                <th className="sticky left-0 z-20 bg-slate-50 border-b border-r border-slate-200 p-4 text-left min-w-[300px]"><span className="text-xs font-bold text-slate-500 uppercase tracking-wider">Engineer</span></th>
                                <th className="bg-slate-50 border-b border-slate-200 p-4 w-24 text-center"><span className="text-xs font-bold text-slate-500 uppercase">Burn ($)</span></th>
                                {weekLabels.map((date, i) => <th key={i} className="bg-slate-50 border-b border-slate-200 p-2 min-w-[100px] text-center"><div className="text-xs font-bold text-slate-700">Week of</div><div className="text-[10px] text-slate-400 font-normal">{date}</div></th>)}
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                            {filteredEngineers.map(eng => {
                                const avgLoad = getTotalUtil(allocations, eng.id, weekKeys);
                                const engAllocs = allocations.filter(a => a.engId === eng.id);
                                const weeklyBurn = Math.round((avgLoad / 100) * 40 * (eng.rate || 0)); // Approx using avg %
                                return (
                                    <React.Fragment key={eng.id}>
                                        <tr className="bg-white group hover:bg-slate-50/50">
                                            <td className="sticky left-0 z-10 bg-white group-hover:bg-slate-50/50 border-r border-slate-200 p-4">
                                                <div className="flex justify-between items-center">
                                                    <div className="flex items-center space-x-3">
                                                        <div className="w-10 h-10 rounded-full bg-slate-800 text-white flex items-center justify-center font-bold text-sm shadow-sm relative">{eng.avatar}{eng.status === 'PTO' && <div className="absolute -bottom-1 -right-1 bg-amber-400 text-[8px] px-1 rounded text-amber-900 font-bold border border-white">PTO</div>}</div>
                                                        <div><h4 className="font-bold text-slate-800 text-sm">{eng.name}</h4><p className="text-xs text-slate-500">{eng.role}</p></div>
                                                    </div>
                                                    <div className="flex items-center space-x-2">
                                                        <button onClick={() => handleFillWeeks(eng.id)} className="p-1.5 text-slate-400 hover:text-blue-600 flex items-center text-xs font-medium" title="Copy Wk1 to All"><Icon icon={Copy} size={12} className="mr-1"/> Fill</button>
                                                        <button onClick={() => handleAddProjectRow(eng.id)} className="ml-2 flex items-center px-2 py-1 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors shadow-sm border border-blue-100 text-xs font-medium"><Icon icon={Plus} size={14} className="mr-1"/> Add</button>
                                                    </div>
                                                </div>
                                            </td>
                                            <td className="p-2 text-center border-r border-slate-100"><div className="text-xs font-bold text-emerald-600">${weeklyBurn.toLocaleString()}</div></td>
                                            {weekKeys.map((dateKey, i) => { 
                                                const load = getUtil(allocations, eng.id, dateKey); 
                                                const isUnder = load < 5;
                                                const isOver = load > 5;
                                                return (
                                                    <td key={i} className={`p-2 text-center border-r border-slate-100 ${isUnder ? 'bg-orange-50 animate-pulse' : ''}`}>
                                                        <div className="w-full h-1.5 rounded-full bg-slate-100 overflow-hidden mb-1">
                                                            <div className={`h-full ${isOver ? 'bg-rose-500' : isUnder ? 'bg-orange-400' : 'bg-emerald-500'}`} style={{width: `${Math.min(100, (load/5)*100)}%`}}></div>
                                                        </div>
                                                        <span className={`text-[10px] font-bold ${isUnder ? 'text-orange-600' : 'text-slate-400'}`}>{load}d</span>
                                                    </td>
                                                ); 
                                            })}
                                        </tr>
                                        {engAllocs.map(alloc => (
                                            <tr key={alloc.id} className="bg-slate-50/30">
                                                <td className="sticky left-0 z-10 bg-slate-50/80 border-r border-slate-200 py-2 pl-16 pr-4 backdrop-blur-sm">
                                                    <div className="flex items-center justify-between group/row">
                                                        <input value={alloc.projectName} onChange={(e) => handleProjectNameChange(alloc.id, e.target.value)} placeholder="Project name..." className="w-full bg-transparent text-sm outline-none px-1 py-0.5" />
                                                        <button onClick={() => handleDeleteAllocation(alloc.id)} className="opacity-0 group-hover/row:opacity-100 text-slate-300 hover:text-red-500"><Icon icon={X} size={14} /></button>
                                                    </div>
                                                </td>
                                                <td className="border-r border-slate-200"></td>
                                                {weekKeys.map((dateKey, idx) => <td key={idx} className="p-0 h-10 border-r border-slate-200 border-b border-slate-100"><UtilizationCell value={alloc.schedule?.[dateKey]} onChange={(v) => handleAllocationWeekChange(alloc.id, dateKey, v)} /></td>)}
                                            </tr>
                                        ))}
                                    </React.Fragment>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            </div>
        );

        // 3. Staff Directory
        const StaffDirectoryView = ({ engineers, openAddStaff, openReviewModal, openEditStaff, handleDeleteStaff }) => (
            <div className="animate-enter space-y-6">
                <div className="flex justify-between items-center bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <div><h3 className="text-xl font-bold text-slate-800">Team Directory</h3><p className="text-sm text-slate-500">Manage engineers, skills, and availability.</p></div>
                    <button onClick={openAddStaff} className="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 shadow-sm"><Icon icon={Plus} size={18} className="mr-2" /> Add Staff</button>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    {engineers.map(eng => (
                        <div key={eng.id} className="bg-white rounded-xl border border-slate-200 shadow-sm p-5 hover:shadow-md transition-shadow relative">
                            {eng.status === 'PTO' && <div className="absolute top-0 right-0 bg-amber-400 text-amber-900 text-[10px] font-bold px-2 py-1 rounded-bl-lg rounded-tr-xl">ON LEAVE</div>}
                            <div className="flex justify-between items-start mb-4">
                                <div className="flex items-center space-x-3"><div className="w-12 h-12 rounded-xl bg-slate-800 text-white flex items-center justify-center font-bold text-lg shadow-sm">{eng.avatar}</div><div><h4 className="font-bold text-slate-800">{eng.name}</h4><p className="text-xs text-slate-500 font-medium">{eng.role}</p></div></div>
                            </div>
                            <div className="flex space-x-2 mb-4">
                                <button onClick={() => openReviewModal(eng)} className="flex-1 flex items-center justify-center px-2 py-1 text-xs font-medium bg-emerald-50 text-emerald-700 rounded hover:bg-emerald-100 transition-colors"><Icon icon={ClipboardList} size={14} className="mr-1"/> Check-in</button>
                                <button onClick={() => openEditStaff(eng)} className="flex-1 flex items-center justify-center px-2 py-1 text-xs font-medium bg-blue-50 text-blue-700 rounded hover:bg-blue-100 transition-colors"><Icon icon={Edit} size={14} className="mr-1"/> Edit</button>
                                <button onClick={() => handleDeleteStaff(eng.id)} className="flex-1 flex items-center justify-center px-2 py-1 text-xs font-medium bg-rose-50 text-rose-700 rounded hover:bg-rose-100 transition-colors"><Icon icon={Trash2} size={14} className="mr-1"/> Del</button>
                            </div>
                            <div className="space-y-2 border-t border-slate-100 pt-3">
                                <div className="flex justify-between text-xs"><span className="text-slate-500">Certifications</span><span className="font-medium text-slate-700">{eng.certs.join(', ') || '-'}</span></div>
                                <div className="flex justify-between text-xs"><span className="text-slate-500">Billable Rate</span><span className="font-medium text-slate-700">${eng.rate}/hr</span></div>
                                <div className="flex justify-between text-xs"><span className="text-slate-500">Renewal</span><span className="font-medium text-slate-700">{eng.renewal || '-'}</span></div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        );

        const StaffModal = ({ isOpen, onClose, editingStaff, handleSave, CERTS }) => {
            if(!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60"><div className="bg-white rounded-xl w-full max-w-lg p-6"><div className="flex justify-between mb-4"><h3 className="font-bold">{editingStaff ? 'Edit' : 'Add'} Staff</h3><button onClick={onClose} className="flex items-center text-sm text-slate-500"><span className="mr-1">Close</span><Icon icon={X} size={20} /></button></div><form onSubmit={handleSave} className="space-y-4"><div className="grid grid-cols-2 gap-4"><input required name="name" defaultValue={editingStaff?.name} placeholder="Name" className="border p-2 rounded w-full" /><input required name="initials" defaultValue={editingStaff?.avatar} placeholder="Initials" className="border p-2 rounded w-full" /></div><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Role</label><input required name="role" defaultValue={editingStaff?.role} className="w-full p-2 border border-slate-200 rounded-lg text-sm" /></div><div className="grid grid-cols-2 gap-4"><input type="number" name="rate" defaultValue={editingStaff?.rate} placeholder="Rate" className="border p-2 rounded w-full" /><input type="number" name="capacity" defaultValue={editingStaff?.capacity || 100} placeholder="Cap %" className="border p-2 rounded w-full" /></div><div className="grid grid-cols-2 gap-4"><select name="status" defaultValue={editingStaff?.status || 'Active'} className="border p-2 rounded w-full"><option value="Active">Active</option><option value="PTO">PTO</option></select><input type="date" name="renewal" defaultValue={editingStaff?.renewal} className="border p-2 rounded w-full" /></div><div className="flex gap-2 flex-wrap">{Object.values(CERTS).map(c=><label key={c} className="flex items-center space-x-1 text-sm"><input type="checkbox" name="certs" value={c} defaultChecked={editingStaff?.certs.includes(c)} /><span>{c}</span></label>)}</div><div className="flex justify-end pt-4"><button type="button" onClick={onClose} className="px-4 py-2 bg-slate-100 rounded-lg text-sm font-bold mr-2">Cancel</button><button type="submit" className="bg-blue-600 text-white px-4 py-2 rounded">Save</button></div></form></div></div>
            );
        };

        const CheckInsCenterView = ({ selectedEngFilter, setSelectedEngFilter, engineers, reviews, openReviewModal }) => {
             const [currentDate, setCurrentDate] = useState(new Date());
             const filteredReviews = useMemo(() => selectedEngFilter === 'ALL' ? reviews : reviews.filter(r => r.engId === parseInt(selectedEngFilter)), [reviews, selectedEngFilter]);
             const changeMonth = (o) => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + o, 1));
             
             const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
             const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();

             return (
                 <div className="space-y-6 animate-enter">
                    <div className="flex justify-between items-center bg-white p-4 rounded-xl border shadow-sm">
                         <h3 className="font-bold">Check-ins</h3>
                         <select value={selectedEngFilter} onChange={e=>setSelectedEngFilter(e.target.value)} className="p-2 border rounded"><option value="ALL">All Staff</option>{engineers.map(e=><option key={e.id} value={e.id}>{e.name}</option>)}</select>
                    </div>
                    <div className="bg-white p-6 rounded-xl border shadow-sm">
                         <div className="flex justify-between mb-4">
                            <button onClick={()=>changeMonth(-1)} className="flex items-center text-sm"><Icon icon={ChevronLeft} size={16}/> Prev</button>
                            <h4 className="font-bold">{currentDate.toLocaleString('default', {month:'long', year:'numeric'})}</h4>
                            <button onClick={()=>changeMonth(1)} className="flex items-center text-sm">Next <Icon icon={ChevronRight} size={16}/></button>
                         </div>
                         <div className="grid grid-cols-7 text-center border-b border-slate-200 bg-slate-100 text-xs font-bold text-slate-600 uppercase py-3">
                            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                         </div>
                         <div className="grid grid-cols-7 gap-1">
                            {[...Array(firstDay)].map((_,i)=><div key={`e-${i}`} className="h-24 bg-slate-50/50 border-b border-r"></div>)}
                            {[...Array(daysInMonth)].map((_, i) => {
                                const d = i+1;
                                const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                                const revs = filteredReviews.filter(r => r.date === dateStr);
                                return <div key={d} className="border-b border-r p-1 h-24 hover:bg-slate-50 cursor-pointer" onClick={() => { if(selectedEngFilter !== 'ALL') openReviewModal(engineers.find(e=>e.id==selectedEngFilter), null, dateStr) }}><div className="text-xs font-bold">{d}</div>{revs.map(r=><div key={r.id} className="text-[10px] bg-emerald-100 p-1 rounded mt-1 truncate" onClick={(e)=>{e.stopPropagation(); openReviewModal(engineers.find(en=>en.id===r.engId), r)}}>{engineers.find(en=>en.id===r.engId)?.name}</div>)}</div>
                            })}
                         </div>
                    </div>
                 </div>
             );
        };

        const TaskCard = ({ task, engineers, openTaskModal, handleArchiveTask, handleCompleteTask, handleRestoreTask }) => {
            const assignee = task.assignee === 0 ? { name: 'Myself', avatar: 'ME' } : engineers.find(e => e.id === task.assignee);
            const isUrgent = task.status !== 'DONE' && !task.archived && (isNearDue(task.due) || isOverdue(task.due));
            const overdue = isOverdue(task.due);
            const statusColors = { 'TODO': 'bg-slate-100 text-slate-600', 'IN_PROGRESS': 'bg-blue-100 text-blue-600', 'DONE': 'bg-emerald-100 text-emerald-600' };

            // In archived view, we show Restore. In active view, we show Complete/Archive.
            return (
                <div onClick={() => openTaskModal(task)} className={`bg-white p-3 rounded-lg border ${isUrgent ? 'border-amber-300 ring-1 ring-amber-200' : 'border-slate-200'} shadow-sm hover:shadow-md transition-all cursor-pointer group relative min-w-[250px] mr-4`}>
                    {isUrgent && <div className={`absolute -top-1.5 -right-1.5 w-3 h-3 rounded-full ${overdue ? 'bg-rose-500' : 'bg-amber-500'} border border-white`}></div>}
                    
                    <div className="absolute top-2 right-2 flex space-x-1 z-10">
                        {task.archived ? (
                             <button onClick={(e) => { e.stopPropagation(); handleRestoreTask(task.id); }} className="p-1 text-blue-500 hover:text-blue-700 bg-white rounded border border-blue-100 shadow-sm" title="Restore Task"><Icon icon={RotateCcw} size={14} /></button>
                        ) : (
                            <>
                                {task.status !== 'DONE' && (
                                    <button onClick={(e) => { e.stopPropagation(); handleCompleteTask(task.id); }} className="p-1 text-emerald-500 hover:text-emerald-700 bg-white rounded border border-emerald-100 shadow-sm" title="Mark Complete"><Icon icon={CheckCircle2} size={14} /></button>
                                )}
                                <button onClick={(e) => { e.stopPropagation(); handleArchiveTask(task.id); }} className="p-1 text-slate-400 hover:text-slate-600 bg-white rounded border border-slate-100 shadow-sm" title="Archive Task"><Icon icon={Archive} size={14} /></button>
                            </>
                        )}
                    </div>

                    <div className="flex justify-between items-start mb-2 pr-16"><span className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">{task.project}</span><span className={`text-[10px] font-bold px-1.5 py-0.5 rounded border ${task.priority === 'HIGH' ? 'bg-rose-100 text-rose-700' : task.priority === 'MEDIUM' ? 'bg-amber-100 text-amber-700' : 'bg-blue-100 text-blue-700'}`}>{task.priority}</span></div>
                    <h4 className="text-sm font-semibold text-slate-800 mb-3 leading-tight">{task.title}</h4>
                    <div className="flex justify-between items-center pt-2 border-t border-slate-50">
                        <div className="flex items-center space-x-2"><div className={`w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold ${task.assignee === 0 ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-600'}`}>{assignee?.avatar || '?'}</div><span className="text-xs text-slate-500 truncate max-w-[80px]">{assignee?.name || 'Unknown'}</span></div>
                        <div className="flex items-center space-x-2">
                             <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${statusColors[task.status]}`}>{task.status.replace('_', ' ')}</span>
                             {!task.archived && <span className={`text-xs font-medium ${new Date(task.due) < new Date() && task.status !== 'DONE' ? 'text-red-600' : 'text-slate-400'}`}>{new Date(task.due).toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}</span>}
                        </div>
                    </div>
                </div>
            );
        };

        const ActionItemsView = ({ actionFilter, setActionFilter, tasks, engineers, openTaskModal, handleArchiveTask, handleCompleteTask, handleRestoreTask }) => {
             const [viewMode, setViewMode] = useState(actionFilter === 'ALL' || typeof actionFilter === 'string' ? actionFilter : 'SPECIFIC');
             const [showArchived, setShowArchived] = useState(false);
             
             useEffect(() => { if(typeof actionFilter === 'number') setViewMode('SPECIFIC'); else setViewMode(actionFilter); }, [actionFilter]);
             
             const filteredTasks = useMemo(() => {
                 let tks = tasks.filter(t => showArchived ? t.archived : !t.archived);
                 if(viewMode === 'ME') tks = tks.filter(t=>t.assignee===0);
                 else if(viewMode === 'STAFF') tks = tks.filter(t=>t.assignee!==0);
                 else if(typeof actionFilter === 'number') tks = tks.filter(t=>t.assignee===actionFilter);
                 // Sort active by due date, archived by ID (creation/completion proxy)
                 return tks.sort((a, b) => showArchived ? b.id - a.id : new Date(a.due) - new Date(b.due));
             }, [tasks, viewMode, actionFilter, showArchived]);

             const handleFilterChange = (mode) => { setViewMode(mode); setActionFilter(mode); };
             
             const columns = [{ id: 0, name: 'Myself', avatar: 'ME' }, ...engineers];
             const visibleColumns = useMemo(() => {
                 if (viewMode === 'ME') return columns.filter(c => c.id === 0);
                 if (viewMode === 'STAFF') return columns.filter(c => c.id !== 0);
                 if (typeof actionFilter === 'number') return columns.filter(c => c.id === actionFilter);
                 return columns;
             }, [columns, viewMode, actionFilter]);

             return (
                 <div className="animate-enter space-y-6 h-full flex flex-col">
                     <div className="flex justify-between bg-white p-4 rounded-xl border shadow-sm">
                        <div className="flex items-center"><h3 className="font-bold mr-4">{showArchived ? 'Archived Items' : 'Action Items'}</h3>{viewMode === 'SPECIFIC' && typeof actionFilter === 'number' && <div className="bg-emerald-100 text-emerald-800 px-3 py-1 rounded-full text-xs font-bold flex items-center">Filtered: {engineers.find(e => e.id === actionFilter)?.name} <button onClick={() => handleFilterChange('ALL')} className="ml-2 hover:text-emerald-600"><Icon icon={X} size={14}/></button></div>}</div>
                        <div className="flex space-x-2">
                             <button onClick={() => setShowArchived(!showArchived)} className={`px-3 py-1 text-xs font-bold rounded flex items-center ${showArchived ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-500'}`}><Icon icon={Archive} size={14} className="mr-1"/> {showArchived ? 'Hide Archived' : 'View Archived'}</button>
                             <div className="w-px bg-slate-200 mx-2"></div>
                             <button onClick={()=>handleFilterChange('ALL')} className={`px-3 py-1 text-xs font-bold rounded ${viewMode==='ALL'?'bg-slate-100 text-slate-800':'text-slate-500'}`}>All</button>
                             <button onClick={()=>handleFilterChange('ME')} className={`px-3 py-1 text-xs font-bold rounded ${viewMode==='ME'?'bg-blue-50 text-blue-700':'text-slate-500'}`}>My Tasks</button>
                             <button onClick={()=>handleFilterChange('STAFF')} className={`px-3 py-1 text-xs font-bold rounded ${viewMode==='STAFF'?'bg-emerald-50 text-emerald-700':'text-slate-500'}`}>Staff</button>
                             <button onClick={()=>openTaskModal()} className="px-3 py-1 bg-blue-600 text-white rounded text-xs ml-2 flex items-center"><Icon icon={Plus} size={14} className="mr-1"/> New Task</button>
                        </div>
                     </div>
                     
                     {showArchived ? (
                         <div className="flex-1 overflow-x-auto pb-4">
                             {/* Archived View uses same card layout but filtered */}
                             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {filteredTasks.length === 0 ? <div className="col-span-full text-center py-10 text-slate-400 text-xs italic">No archived items found.</div> : 
                                    filteredTasks.map(t => <TaskCard key={t.id} task={t} engineers={engineers} openTaskModal={openTaskModal} handleArchiveTask={handleArchiveTask} handleCompleteTask={handleCompleteTask} handleRestoreTask={handleRestoreTask} />)
                                }
                             </div>
                         </div>
                     ) : (
                         <div className="flex-1 overflow-x-auto pb-4">
                             <div className="flex gap-4 h-full" style={{ minWidth: 'min-content' }}>
                                 {visibleColumns.map(col => {
                                     const colTasks = filteredTasks.filter(t => t.assignee === col.id);
                                     return (
                                         <div key={col.id} className="w-80 bg-slate-50 p-3 rounded-xl border border-slate-200 flex-shrink-0 flex flex-col">
                                             <div className="flex items-center mb-3 pb-2 border-b border-slate-200">
                                                 <div className={`w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold mr-2 ${col.id === 0 ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-600'}`}>{col.avatar}</div>
                                                 <h4 className="font-bold text-sm text-slate-700">{col.name}</h4>
                                                 <span className="ml-auto text-xs bg-white px-2 py-0.5 rounded border border-slate-200 text-slate-400">{colTasks.length}</span>
                                             </div>
                                             <div className="flex-1 overflow-y-auto space-y-3">
                                                 {colTasks.length === 0 ? <div className="text-center py-10 text-slate-400 text-xs italic">No active tasks</div> : colTasks.map(t => <TaskCard key={t.id} task={t} engineers={engineers} openTaskModal={openTaskModal} handleArchiveTask={handleArchiveTask} handleCompleteTask={handleCompleteTask} />)}
                                             </div>
                                         </div>
                                     );
                                 })}
                             </div>
                         </div>
                     )}
                 </div>
             )
        };
        
        const TaskModal = ({ isOpen, onClose, editingTask, handleSave, engineers, handleDelete }) => {
            if(!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60"><div className="bg-white p-6 rounded-xl w-96"><div className="flex justify-between mb-4"><h3 className="font-bold">{editingTask ? 'Edit' : 'New'} Task</h3><button onClick={onClose} className="flex items-center text-sm text-slate-500"><span className="mr-1">Close</span><Icon icon={X} size={18} /></button></div><form onSubmit={handleSave} className="space-y-3"><input name="title" defaultValue={editingTask?.title} placeholder="Title" className="border p-2 rounded w-full" required /><select name="assignee" defaultValue={editingTask?.assignee || 0} className="border p-2 rounded w-full"><option value="0">Myself</option>{engineers.map(e=><option key={e.id} value={e.id}>{e.name}</option>)}</select><input type="date" name="due" defaultValue={editingTask?.due} className="border p-2 rounded w-full" required /><select name="priority" defaultValue={editingTask?.priority || 'MEDIUM'} className="border p-2 rounded w-full"><option value="HIGH">High</option><option value="MEDIUM">Medium</option><option value="LOW">Low</option></select><select name="status" defaultValue={editingTask?.status || 'TODO'} className="border p-2 rounded w-full"><option value="TODO">To Do</option><option value="IN_PROGRESS">In Progress</option><option value="DONE">Done</option></select><input name="project" defaultValue={editingTask?.project} placeholder="Project" className="border p-2 rounded w-full" /><div className="flex justify-end space-x-2">{editingTask && <button type="button" onClick={()=>{handleDelete(editingTask.id);onClose();}} className="text-red-500 px-3">Delete</button>}<button type="submit" className="bg-blue-600 text-white px-4 py-2 rounded">Save</button></div></form></div></div>
            );
        };

        const ReviewModal = ({ isOpen, onClose, reviewingStaff, editingReview, handleSave, reviews }) => {
            if(!isOpen) return null;
            const [activeTab, setActiveTab] = useState(editingReview ? 'new' : 'new');
            const [cFields, setCFields] = useState(editingReview?.customFields || []);
            const [tempWorkload, setTempWorkload] = useState(editingReview?.workload || '');
            const [tempGoals, setTempGoals] = useState(editingReview?.goals || '');
            const [tempGeneral, setTempGeneral] = useState(editingReview?.general || '');
            
            useEffect(() => { if(editingReview) { setTempWorkload(editingReview.workload); setTempGoals(editingReview.goals); setTempGeneral(editingReview.general); setCFields(editingReview.customFields || []); } else { setTempWorkload(''); setTempGoals(''); setTempGeneral(''); setCFields([]); } }, [editingReview, isOpen]);

            const handleSubmit = (e) => { e.preventDefault(); handleSave({ workload: tempWorkload, goals: tempGoals, general: tempGeneral, customFields: cFields }); };
            const addField = () => setCFields([...cFields, {id: Date.now(), label: '', value: ''}]);
            const updateField = (id, k, v) => setCFields(cFields.map(f=>f.id===id?{...f,[k]:v}:f));
            
            return <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60"><div className="bg-white w-full max-w-xl rounded-xl flex flex-col max-h-[80vh]"><div className="p-4 border-b flex justify-between"><h3 className="font-bold">Review: {reviewingStaff.name}</h3><button onClick={onClose} className="flex items-center text-sm text-slate-500"><span className="mr-1">Close</span><Icon icon={X} size={18} /></button></div><div className="flex border-b"><button onClick={()=>setActiveTab('new')} className={`flex-1 p-2 ${activeTab==='new'?'border-b-2 border-blue-500':''}`}>Entry</button><button onClick={()=>setActiveTab('history')} className={`flex-1 p-2 ${activeTab==='history'?'border-b-2 border-blue-500':''}`}>History</button></div><div className="p-4 overflow-y-auto">{activeTab === 'new' ? <form id="revForm" onSubmit={handleSubmit} className="space-y-3"><textarea value={tempWorkload} onChange={e=>setTempWorkload(e.target.value)} placeholder="Workload..." className="w-full border p-2 rounded" rows="3"></textarea><textarea value={tempGoals} onChange={e=>setTempGoals(e.target.value)} placeholder="Goals..." className="w-full border p-2 rounded" rows="3"></textarea><textarea value={tempGeneral} onChange={e=>setTempGeneral(e.target.value)} placeholder="General..." className="w-full border p-2 rounded" rows="3"></textarea><div className="space-y-2"><div className="flex justify-between"><span className="text-xs font-bold">Extra</span><button type="button" onClick={addField} className="text-xs text-blue-600">+ Add Point</button></div>{cFields.map(f=><div key={f.id} className="flex gap-2"><input placeholder="Topic" value={f.label} onChange={e=>updateField(f.id,'label',e.target.value)} className="border p-1 w-1/3 text-xs"/><input placeholder="Notes" value={f.value} onChange={e=>updateField(f.id,'value',e.target.value)} className="border p-1 flex-1 text-xs"/></div>)}</div></form> : <div className="space-y-2">{reviews.filter(r=>r.engId===reviewingStaff.id).map(r=><div key={r.id} className="border p-2 rounded"><div className="font-bold text-xs">{r.date}</div><div className="text-sm">{r.workload}</div></div>)}</div>}</div>{activeTab === 'new' && <div className="p-4 border-t flex justify-end"><button type="submit" form="revForm" className="bg-blue-600 text-white px-4 py-2 rounded">Save</button></div>}</div></div>;
        };

        // --- Settings View ---
        const SettingsView = ({ engineers, allocations, reviews, tasks, scratchpad, loadData }) => {
            const handleExport = () => {
                const data = { engineers, allocations, reviews, tasks, scratchpad };
                const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `staffing_backup_${new Date().toISOString().split('T')[0]}.json`; a.click();
            };
            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        loadData(data);
                        alert('Data imported successfully!');
                    } catch (err) { alert('Invalid file format'); }
                };
                reader.readAsText(file);
            };

            return (
                <div className="animate-enter space-y-6">
                    <div className="bg-white p-6 rounded-xl border shadow-sm">
                        <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center"><Icon icon={Database} size={20} className="mr-2"/> Data Management</h3>
                        <p className="text-sm text-slate-500 mb-6">Export your data to move to another device or backup your work. Import a JSON file to restore data.</p>
                        <div className="flex gap-4">
                            <button onClick={handleExport} className="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"><Icon icon={Download} size={16} className="mr-2"/> Export Data</button>
                            <label className="flex items-center px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors cursor-pointer">
                                <Icon icon={Upload} size={16} className="mr-2"/> Import Data
                                <input type="file" accept=".json" onChange={handleImport} className="hidden" />
                            </label>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main Component ---
        const StaffingTool = () => {
            const [view, setView] = useState('dashboard');
            
            // Note: Keys reverted to 'bridgeops_' to restore previous user data
            const [engineers, setEngineers] = useState(() => loadState('bridgeops_engineers', INITIAL_ENGINEERS));
            const [allocations, setAllocations] = useState(() => loadState('bridgeops_allocations', INITIAL_ALLOCATIONS));
            const [reviews, setReviews] = useState(() => loadState('bridgeops_reviews', INITIAL_REVIEWS));
            const [tasks, setTasks] = useState(() => loadState('bridgeops_tasks', INITIAL_TASKS));
            const [scratchpad, setScratchpad] = useState(() => loadState('bridgeops_scratchpad', ''));
            
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedEngFilter, setSelectedEngFilter] = useState('ALL');
            const [actionFilter, setActionFilter] = useState('ALL');
            const [isStaffModalOpen, setIsStaffModalOpen] = useState(false);
            const [editingStaff, setEditingStaff] = useState(null);
            const [isReviewModalOpen, setIsReviewModalOpen] = useState(false);
            const [reviewingStaff, setReviewingStaff] = useState(null);
            const [editingReview, setEditingReview] = useState(null); 
            const [reviewDateOverride, setReviewDateOverride] = useState(null); 
            const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
            const [editingTask, setEditingTask] = useState(null);

            useEffect(() => { localStorage.setItem('bridgeops_engineers', JSON.stringify(engineers)); }, [engineers]);
            useEffect(() => { localStorage.setItem('bridgeops_allocations', JSON.stringify(allocations)); }, [allocations]);
            useEffect(() => { localStorage.setItem('bridgeops_reviews', JSON.stringify(reviews)); }, [reviews]);
            useEffect(() => { localStorage.setItem('bridgeops_tasks', JSON.stringify(tasks)); }, [tasks]);
            useEffect(() => { localStorage.setItem('bridgeops_scratchpad', JSON.stringify(scratchpad)); }, [scratchpad]);

            // Data Loader for Import
            const loadData = (data) => {
                if (data.engineers) setEngineers(data.engineers);
                if (data.allocations) setAllocations(data.allocations);
                if (data.reviews) setReviews(data.reviews);
                if (data.tasks) setTasks(data.tasks);
                if (data.scratchpad) setScratchpad(data.scratchpad);
            };

            // Create Week Keys for UI Rendering
            const { weekLabels, weekKeys } = useMemo(() => {
                const labels = [];
                const keys = [];
                let curr = new Date();
                curr.setDate(curr.getDate() + (1 + 7 - curr.getDay()) % 7); // Next Monday
                
                // Adjust to current monday if we want to show "This Week" as first col
                const today = new Date();
                const diff = today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1);
                const currentMonday = new Date(today.setDate(diff));
                currentMonday.setHours(0,0,0,0);
                
                // Override for now to match user expectation of "current week" being first
                curr = currentMonday;

                for (let i = 0; i < 4; i++) {
                    const d = new Date(curr);
                    d.setDate(d.getDate() + (i * 7));
                    labels.push(d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    keys.push(formatDateKey(d));
                }
                return { weekLabels: labels, weekKeys: keys };
            }, []);

            const filteredEngineers = useMemo(() => engineers.filter(e => e.name.toLowerCase().includes(searchQuery.toLowerCase())), [engineers, searchQuery]);

            const handleSaveStaff = (e) => { e.preventDefault(); const fd = new FormData(e.target); const certs = fd.getAll('certs'); const s = { id: editingStaff ? editingStaff.id : Math.max(...engineers.map(e=>e.id),0)+1, name: fd.get('name'), role: fd.get('role'), capacity: parseInt(fd.get('capacity')), avatar: fd.get('initials').toUpperCase(), rate: parseFloat(fd.get('rate'))||0, status: fd.get('status'), renewal: fd.get('renewal'), certs }; setEngineers(editingStaff ? engineers.map(e=>e.id===s.id?s:e) : [...engineers, s]); setIsStaffModalOpen(false); setEditingStaff(null); };
            const handleSaveReview = (data) => { const r = { id: editingReview ? editingReview.id : Date.now(), engId: reviewingStaff.id, date: reviewDateOverride || new Date().toISOString().split('T')[0], ...data }; if(editingReview) setReviews(reviews.map(rv=>rv.id===r.id?r:rv)); else setReviews([r, ...reviews]); setIsReviewModalOpen(false); setReviewingStaff(null); setEditingReview(null); setReviewDateOverride(null); };
            const handleSaveTask = (e) => { e.preventDefault(); const fd = new FormData(e.target); const t = { id: editingTask ? editingTask.id : Date.now(), title: fd.get('title'), assignee: parseInt(fd.get('assignee')), status: fd.get('status'), priority: fd.get('priority'), due: fd.get('due'), project: fd.get('project'), archived: editingTask ? editingTask.archived : false }; setTasks(editingTask ? tasks.map(tk=>tk.id===t.id?t:tk) : [...tasks, t]); setIsTaskModalOpen(false); setEditingTask(null); };
            const handleDeleteTask = (id) => setTasks(tasks.filter(t=>t.id!==id));
            const handleArchiveTask = (id) => setTasks(tasks.map(t=>t.id===id?{...t, archived: true}:t));
            const handleRestoreTask = (id) => setTasks(tasks.map(t=>t.id===id?{...t, archived: false}:t));
            const handleCompleteTask = (id) => setTasks(tasks.map(t=>t.id===id?{...t, status:'DONE'}:t));
            const handleDeleteStaff = (id) => { if(confirm('Remove?')) { setEngineers(engineers.filter(e=>e.id!==id)); setAllocations(allocations.filter(a=>a.engId!==id)); }};
            
            // Updated handlers for Date-Keyed Allocations
            const handleAllocationWeekChange = (allocId, dateKey, val) => {
                setAllocations(allocations.map(a => {
                    if (a.id === allocId) {
                        const newSchedule = { ...a.schedule, [dateKey]: val };
                        return { ...a, schedule: newSchedule };
                    }
                    return a;
                }));
            };

            const handleProjectNameChange = (aid, val) => setAllocations(allocations.map(a=>a.id===aid?{...a, projectName: val}:a));
            const handleAddProjectRow = (eid) => setAllocations([...allocations, {id: Date.now(), engId: eid, projectName: '', schedule: {}}]);
            const handleDeleteAllocation = (id) => setAllocations(allocations.filter(a=>a.id!==id));
            
            const handleFillWeeks = (eid) => { 
                if(confirm("Copy Week 1 values to Weeks 2-4?")) {
                    setAllocations(allocations.map(a => {
                        if (a.engId === eid) {
                            const val = a.schedule?.[weekKeys[0]] || 0;
                            const newSchedule = { ...a.schedule };
                            weekKeys.slice(1).forEach(k => newSchedule[k] = val);
                            return { ...a, schedule: newSchedule };
                        }
                        return a;
                    }));
                }
            };
            
            const exportCSV = () => { let csv="Name,Project,Wk1,Wk2,Wk3,Wk4\n"; engineers.forEach(e=>{ allocations.filter(a=>a.engId===e.id).forEach(a=>{ csv+=`${e.name},${a.projectName},${weekKeys.map(k=>a.schedule?.[k]||0).join(',')}\n`})}); const b=new Blob([csv],{type:'text/csv'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='res.csv'; a.click(); };

            const openAddStaff = () => { setEditingStaff(null); setIsStaffModalOpen(true); };
            const openEditStaff = (s) => { setEditingStaff(s); setIsStaffModalOpen(true); };
            const openReviewModal = (s, r=null, d=null) => { setReviewingStaff(s); setEditingReview(r); setReviewDateOverride(d); setIsReviewModalOpen(true); };
            const openTaskModal = (t=null) => { setEditingTask(t); setIsTaskModalOpen(true); };

            return (
                <div className="flex min-h-screen font-sans text-slate-900">
                    <aside className="w-64 bg-slate-900 text-slate-300 flex flex-col fixed h-full z-30 shadow-2xl">
                        <div className="p-6 flex items-center space-x-3 text-white mb-6"><div className="p-2 bg-blue-600 rounded-lg"><Icon icon={HardHat} size={24} /></div><div><h1 className="font-bold text-lg tracking-tight">Staffing Tool</h1><p className="text-xs text-slate-400 uppercase tracking-widest">Manager</p></div></div>
                        <nav className="flex-1 px-3 space-y-1">
                            {[{id:'dashboard', icon:LayoutDashboard, label:'Overview'}, {id:'planning', icon:CalendarRange, label:'Resource Plan'}, {id:'staff', icon:Users, label:'Staff Directory'}, {id:'reviews', icon:FileText, label:'Monthly Check-ins'}, {id:'tasks', icon:ListTodo, label:'Action Items'}, {id:'settings', icon:Settings, label:'Settings'}].map(item => (
                                <button key={item.id} onClick={() => setView(item.id)} className={`w-full flex items-center space-x-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors ${view === item.id ? 'bg-blue-600 text-white' : 'hover:bg-slate-800 hover:text-white'}`}><Icon icon={item.icon} size={18} /><span>{item.label}</span></button>
                            ))}
                        </nav>
                    </aside>
                    <main className="flex-1 ml-64 flex flex-col min-h-screen">
                        <header className="h-16 bg-white border-b border-slate-200 sticky top-0 z-20 px-8 flex items-center justify-between shadow-sm"><h2 className="text-lg font-semibold text-slate-800 capitalize">{view === 'dashboard' ? 'Executive Overview' : view.charAt(0).toUpperCase() + view.slice(1).replace(/([A-Z])/g, ' $1').trim()}</h2></header>
                        <div className="p-8 max-w-[1600px] w-full mx-auto">
                            {view === 'dashboard' && <DashboardView engineers={engineers} allocations={allocations} tasks={tasks} reviews={reviews} scratchpad={scratchpad} setScratchpad={setScratchpad} setView={setView} setSelectedEngFilter={setSelectedEngFilter} setActionFilter={setActionFilter} weekKeys={weekKeys} />}
                            {view === 'planning' && <PlanningGrid searchQuery={searchQuery} setSearchQuery={setSearchQuery} exportCSV={exportCSV} weekLabels={weekLabels} weekKeys={weekKeys} filteredEngineers={filteredEngineers} allocations={allocations} handleFillWeeks={handleFillWeeks} handleAddProjectRow={handleAddProjectRow} handleDeleteAllocation={handleDeleteAllocation} handleProjectNameChange={handleProjectNameChange} handleAllocationWeekChange={handleAllocationWeekChange} />}
                            {view === 'staff' && <StaffDirectoryView engineers={engineers} openAddStaff={openAddStaff} openReviewModal={openReviewModal} openEditStaff={openEditStaff} handleDeleteStaff={handleDeleteStaff} />}
                            {view === 'reviews' && <CheckInsCenterView selectedEngFilter={selectedEngFilter} setSelectedEngFilter={setSelectedEngFilter} engineers={engineers} reviews={reviews} openReviewModal={openReviewModal} />}
                            {view === 'tasks' && <ActionItemsView actionFilter={actionFilter} setActionFilter={setActionFilter} tasks={tasks} engineers={engineers} openTaskModal={openTaskModal} handleDeleteTask={handleDeleteTask} handleArchiveTask={handleArchiveTask} handleCompleteTask={handleCompleteTask} handleRestoreTask={handleRestoreTask} />}
                            {view === 'settings' && <SettingsView engineers={engineers} allocations={allocations} reviews={reviews} tasks={tasks} scratchpad={scratchpad} loadData={loadData} />}
                        </div>
                        <StaffModal isOpen={isStaffModalOpen} onClose={() => setIsStaffModalOpen(false)} editingStaff={editingStaff} handleSave={handleSaveStaff} CERTS={CERTS} />
                        <ReviewModal isOpen={isReviewModalOpen} onClose={() => setIsReviewModalOpen(false)} reviewingStaff={reviewingStaff} editingReview={editingReview} handleSave={handleSaveReview} reviews={reviews} />
                        <TaskModal isOpen={isTaskModalOpen} onClose={() => setIsTaskModalOpen(false)} editingTask={editingTask} handleSave={handleSaveTask} engineers={engineers} handleDelete={handleDeleteTask} />
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StaffingTool />);
    </script>
</body>
</html>
